/**
 * @description This ruleset enforces a role-based access control model for the Maroc Sport Hub application.
 * It provides granular permissions for different user roles (super_admin, admin, user) across various data collections.
 * The core security principle is Database-Based Access Control (DBAC), where permissions are determined by the existence
 * of documents in the `roles_admin` and `roles_super_admin` collections.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**************************************************
     * Helper Functions
     **************************************************/

    function isSignedIn() {
      return request.auth != null;
    }

    function isSuperAdmin() {
      return exists(/databases/$(database)/documents/roles_super_admin/$(request.auth.uid));
    }
    
    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid)) || isSuperAdmin();
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**************************************************
     * Collection: users
     * Description: Stores public user profile data.
     **************************************************/
    match /users/{userId} {
      allow get: if isSignedIn();
      allow list: if isSuperAdmin(); // Only super admins can list all users
      allow create: if isOwner(userId); // Any signed-in user can create their own profile
      allow update: if isOwner(userId) || isSuperAdmin(); // Users can update their own profile, super admins can update any
      allow delete: if isOwner(userId) || isSuperAdmin();
    }

    /**************************************************
     * Collections: roles_*
     * Description: These collections grant roles via document existence.
     **************************************************/
    match /roles_admin/{userId} {
      // Allow reading own role, super admins can manage all roles.
      allow get: if isOwner(userId) || isSuperAdmin();
      allow list, create, update, delete: if isSuperAdmin();
    }

    match /roles_super_admin/{userId} {
      // Allow any signed-in user to check their own super_admin status.
      // This is crucial for the isSuperAdmin() function to work correctly.
      allow get: if isOwner(userId) && isSignedIn();
      // Only super admins can list or modify roles.
      allow list, create, update, delete: if isSuperAdmin();
    }
    
    /**************************************************
     * Collection: facilities
     * Description: Manages sports facility data.
     **************************************************/
    match /facilities/{facilityId} {
      allow get, list: if true; // Publicly readable
      allow create: if isAdmin();
      allow update, delete: if (isAdmin() && resource.data.adminId == request.auth.uid) || isSuperAdmin();
    }
    
    /**************************************************
     * Collection: equipments
     * Description: Manages sports equipment data.
     **************************************************/
    match /equipments/{equipmentId} {
      allow get, list: if true; // Publicly readable
      allow create, update, delete: if isAdmin();
    }

    /**************************************************
     * Subcollection: imports
     * Description: Manages data imports by admins.
     **************************************************/
    match /users/{adminId}/imports/{importId} {
      allow read, write: if (isOwner(adminId) && isAdmin()) || isSuperAdmin();
    }

    /**************************************************
     * Collection: audit_logs
     * Description: Logs system actions.
     **************************************************/
    match /audit_logs/{auditLogId} {
      allow read: if isSuperAdmin();
      allow write: if false; // Logs should be created server-side
    }
  }
}
