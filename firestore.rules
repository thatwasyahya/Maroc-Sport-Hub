
rules_version = '2';

function getUserRole() {
  return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
}

function isSuperAdmin() {
  return getUserRole() == 'super_admin';
}

function isAdmin() {
  return getUserRole() in ['admin', 'super_admin'];
}

function isOwner(userId) {
  return request.auth != null && request.auth.uid == userId;
}

// Schema validation functions based on backend.json
function validateUser(data) {
  return data.id is string &&
         data.email is string && data.email.matches('.+@.+\..+') &&
         data.role is string && data.role in ['user', 'admin', 'super_admin'] &&
         (!data.keys().hasAny(['phoneNumber']) || data.phoneNumber is string || data.phoneNumber == null) &&
         (!data.keys().hasAny(['gender']) || data.gender in ['Male', 'Female'] || data.gender == null) &&
         (!data.keys().hasAny(['jobTitle']) || data.jobTitle is string) &&
         (!data.keys().hasAny(['city']) || data.city is string);
}

function validateFacility(data) {
    return data.name is string && data.name.size() > 0 &&
           data.adminId is string;
}

function validateFacilityRequest(data) {
    return data.userId is string &&
           data.userName is string &&
           data.userEmail is string && data.userEmail.matches('.+@.+\..+') &&
           data.status is string && data.status in ['pending', 'approved', 'rejected'] &&
           data.name is string && data.name.size() > 0;
}

function validateSettings(data) {
    return data.appName is string && data.appName.size() > 0;
}

function validateContactMessage(data) {
    return data.name is string && data.name.size() > 0 &&
           data.email is string && data.email.matches('.+@.+\..+') &&
           data.message is string && data.message.size() > 0 &&
           data.status is string && data.status in ['read', 'unread'] &&
           data.createdAt is timestamp;
}


service cloud.firestore {
  match /databases/{database}/documents {

    match /users/{userId} {
      allow read: if request.auth != null;
      // Allow create for anyone (signup)
      allow create: if request.auth != null && isOwner(userId) && validateUser(request.resource.data);
      // Allow user to update their own profile, but NOT change their role. Admins can change anything.
      allow update: if request.auth != null && validateUser(request.resource.data) &&
                      (isOwner(userId) && request.resource.data.role == resource.data.role) || isAdmin();
      // Only admins can delete users (except a user deleting their own account)
      allow delete: if request.auth != null && (isOwner(userId) || isAdmin());
    }

    match /facilities/{facilityId} {
      allow read: if true;
      // Only admins can create, update, or delete facilities.
      allow write: if request.auth != null && isAdmin() && validateFacility(request.resource.data);
    }

    match /facilityRequests/{requestId} {
      // Authenticated users can create requests.
      allow create: if request.auth != null && isOwner(request.resource.data.userId) && validateFacilityRequest(request.resource.data);
      
      // Admins can read/update/delete any request. Users can only read/update/delete their own.
      allow read, update, delete: if request.auth != null && (isAdmin() || isOwner(resource.data.userId));
      
      // Prevent users from querying other users' requests. Admins can query all.
      allow list: if request.auth != null && (isAdmin() || request.query.where.userId == request.auth.uid);
    }
    
    match /settings/{settingId} {
      allow read: if true;
      // Only admins can write to settings.
      allow write: if request.auth != null && isAdmin() && validateSettings(request.resource.data);
    }
    
    match /contactMessages/{messageId} {
      // Anyone can create a contact message (public contact form)
      allow create: if validateContactMessage(request.resource.data);
      // Only admins can read, update, or delete contact messages
      allow read, update, delete: if request.auth != null && isAdmin();
    }
  }
}
