{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user in the system.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user."
        },
        "email": {
          "type": "string",
          "description": "Email address of the user.",
          "format": "email"
        },
        "role": {
          "type": "string",
          "description": "Role of the user (e.g., super_admin, admin, user)."
        },
        "firstName": {
          "type": "string",
          "description": "First name of the user."
        },
        "lastName": {
          "type": "string",
          "description": "Last name of the user."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the user was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp indicating when the user was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "email",
        "role"
      ]
    },
    "Facility": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Facility",
      "type": "object",
      "description": "Represents a sports facility.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the facility."
        },
        "name": {
          "type": "string",
          "description": "Name of the facility."
        },
        "description": {
          "type": "string",
          "description": "Description of the facility."
        },
        "latitude": {
          "type": "number",
          "description": "Latitude of the facility location."
        },
        "longitude": {
          "type": "number",
          "description": "Longitude of the facility location."
        },
        "sports": {
          "type": "array",
          "description": "List of sports supported by the facility.",
          "items": {
            "type": "string"
          }
        },
        "address": {
          "type": "string",
          "description": "Address of the facility."
        },
        "city": {
          "type": "string",
          "description": "City where the facility is located."
        },
        "region": {
          "type": "string",
          "description": "Region where the facility is located."
        },
        "indoor": {
          "type": "boolean",
          "description": "Indicates if the facility is indoor."
        },
        "accessibility": {
          "type": "string",
          "description": "Accessibility information for the facility."
        },
        "adminId": {
          "type": "string",
          "description": "Reference to the Admin user who manages this facility. (Relationship: User 1:N Facility)"
        }
      },
      "required": [
        "id",
        "name",
        "latitude",
        "longitude"
      ]
    },
    "Reservation": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Reservation",
      "type": "object",
      "description": "Represents a reservation for a facility.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the reservation."
        },
        "facilityId": {
          "type": "string",
          "description": "Reference to the Facility being reserved. (Relationship: Facility 1:N Reservation)"
        },
        "userId": {
          "type": "string",
          "description": "Reference to the User who made the reservation. (Relationship: User 1:N Reservation)"
        },
        "startTime": {
          "type": "string",
          "description": "Start time of the reservation.",
          "format": "date-time"
        },
        "endTime": {
          "type": "string",
          "description": "End time of the reservation.",
          "format": "date-time"
        },
        "status": {
          "type": "string",
          "description": "Status of the reservation (e.g., pending, confirmed, cancelled)."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the reservation was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp indicating when the reservation was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "facilityId",
        "userId",
        "startTime",
        "endTime",
        "status"
      ]
    },
    "Import": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Import",
      "type": "object",
      "description": "Represents an Excel import operation.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the import."
        },
        "adminId": {
          "type": "string",
          "description": "Reference to the Admin user who initiated the import. (Relationship: User 1:N Import)"
        },
        "filename": {
          "type": "string",
          "description": "Name of the imported file."
        },
        "status": {
          "type": "string",
          "description": "Status of the import (e.g., pending, processing, completed, failed)."
        },
        "report": {
          "type": "string",
          "description": "Report of the import operation, including success and error counts."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the import was started.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp indicating when the import was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "adminId",
        "filename",
        "status"
      ]
    },
    "AuditLog": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "AuditLog",
      "type": "object",
      "description": "Represents an audit log entry.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the audit log entry."
        },
        "userId": {
          "type": "string",
          "description": "Reference to the User who performed the action. (Relationship: User 1:N AuditLog)"
        },
        "action": {
          "type": "string",
          "description": "Action performed (e.g., create, update, delete)."
        },
        "entityType": {
          "type": "string",
          "description": "Type of entity affected (e.g., User, Facility, Reservation)."
        },
        "entityId": {
          "type": "string",
          "description": "ID of the entity affected."
        },
        "timestamp": {
          "type": "string",
          "description": "Timestamp of the action.",
          "format": "date-time"
        },
        "details": {
          "type": "string",
          "description": "Additional details about the action."
        }
      },
      "required": [
        "id",
        "userId",
        "action",
        "entityType",
        "entityId",
        "timestamp"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user profile data. Accessible only by the user and super admins.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            }
          ]
        }
      },
      {
        "path": "/facilities/{facilityId}",
        "definition": {
          "entityName": "Facility",
          "schema": {
            "$ref": "#/backend/entities/Facility"
          },
          "description": "Stores sports facility data. Includes denormalized 'adminId' for authorization independence.",
          "params": [
            {
              "name": "facilityId",
              "description": "The unique identifier of the facility."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/reservations/{reservationId}",
        "definition": {
          "entityName": "Reservation",
          "schema": {
            "$ref": "#/backend/entities/Reservation"
          },
          "description": "Stores reservation data for a user. Accessible only by the user and admins.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            },
            {
              "name": "reservationId",
              "description": "The unique identifier of the reservation."
            }
          ]
        }
      },
      {
        "path": "/users/{adminId}/imports/{importId}",
        "definition": {
          "entityName": "Import",
          "schema": {
            "$ref": "#/backend/entities/Import"
          },
          "description": "Stores Excel import data initiated by an admin. Accessible only by the admin and super admins.",
          "params": [
            {
              "name": "adminId",
              "description": "The unique identifier of the admin."
            },
            {
              "name": "importId",
              "description": "The unique identifier of the import operation."
            }
          ]
        }
      },
      {
        "path": "/audit_logs/{auditLogId}",
        "definition": {
          "entityName": "AuditLog",
          "schema": {
            "$ref": "#/backend/entities/AuditLog"
          },
          "description": "Stores audit log entries. Accessible only by super admins.",
          "params": [
            {
              "name": "auditLogId",
              "description": "The unique identifier of the audit log entry."
            }
          ]
        }
      },
      {
        "path": "/roles_admin/{userId}",
        "definition": {
          "entityName": "RoleAdmin",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Indicates that a user is an admin. Existence determines admin role.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            }
          ]
        }
      },
      {
        "path": "/roles_super_admin/{userId}",
        "definition": {
          "entityName": "RoleSuperAdmin",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Indicates that a user is a super admin. Existence determines super admin role.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            }
          ]
        }
      }
    ],
    "reasoning": "This Firestore structure is designed to support the Maroc Sport Hub application, focusing on security, scalability, and maintainability. It adheres to the principles of Authorization Independence, Clarity of Intent, DBAC (Database-Based Access Control), and QAPs (Rules are not Filters). The structure facilitates role-based access control (super_admin, admin, user) and supports core features like facility mapping, Excel import, user authentication, booking system, and an admin dashboard.\n\n**Authorization Independence:**\n*   The `Facility` document includes the `adminId` field, which denormalizes the relationship between `User` and `Facility`. This eliminates the need for `get()` calls to the `users` collection to verify admin access to facilities.\n*   Similarly, the `Reservation` includes both `facilityId` and `userId`, removing the need to fetch related documents for authorization.\n*   Role existence is leveraged for admins and super admins. The presence of a document in `/roles_admin/{userId}` and `/roles_super_admin/{userId}` grants the respective role. This existence check is more efficient than reading the user document to check a `role` field.\n\n**Structural Segregation:**\n*   The structure avoids mixing data with different access needs in the same collection. For instance, user profiles are stored under `/users/{userId}`, ensuring private access, while facilities are in the `/facilities` collection, managed by admins.\n*   Admin-specific data, such as imports, is stored under `/users/{adminId}/imports`, further segregating access.\n\n**Access Modeling:**\n*   Path-based ownership is used for user-owned data like reservations (`/users/{userId}/reservations/{reservationId}`).\n*   The admin-facility relationship is modeled using the `adminId` field in the `Facility` document, enabling efficient queries for facilities managed by a specific admin.\n*   Global roles are managed using existence checks in dedicated collections (`/roles_admin/{userId}`, `/roles_super_admin/{userId}`).\n\n**QAPs (Rules are not Filters):**\n*   The separation of data into collections based on access requirements (e.g., user-owned reservations vs. admin-managed facilities) enables secure `list` operations without the need for filtering in rules.\n*   The use of existence checks for admin and super admin roles allows for efficient role-based filtering of data.\n\n**Invariants:**\n*   Timestamps (`createdAt`, `updatedAt`) are included in entities to maintain data integrity and support auditing.\n*   The structure supports the integrity of ownership by explicitly defining relationships between entities (e.g., `Facility.adminId` links to `User.id`)."
  }
}